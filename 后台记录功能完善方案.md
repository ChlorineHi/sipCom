# 后台记录功能完善方案

## 当前功能分析

### 已实现的记录功能

#### 1. **通话记录 (CallLog)**
**表结构**:
```sql
- id: 主键
- caller: 主叫用户名
- callee: 被叫用户名
- call_type: 通话类型 (AUDIO, VIDEO)
- status: 通话状态 (MISSED, REJECTED, COMPLETED)
- duration: 通话时长（秒）
- is_group_call: 是否群组通话
- group_id: 群组ID
- created_at: 通话时间
```

**已有功能**:
- ✅ 保存通话记录
- ✅ 查询用户通话记录
- ✅ 查询群组通话记录
- ✅ 统计今日通话时长
- ✅ 获取所有通话记录

**缺失功能**:
- ❌ **会议室通话记录**（新增的聊天室/会议室功能没有记录）
- ❌ 通话记录的详细统计（按天、周、月）
- ❌ 通话记录搜索和筛选
- ❌ 通话质量记录（丢包率、延迟等）

#### 2. **消息记录 (Message)**
**表结构**:
```sql
- id: 主键
- from_user: 发送者
- to_user: 接收者
- content: 消息内容
- type: 消息类型 (TEXT, IMAGE, AUDIO, VIDEO)
- file_url: 文件URL
- is_group: 是否群消息
- is_read: 是否已读
- created_at: 发送时间
```

**已有功能**:
- ✅ 保存消息
- ✅ 查询聊天历史
- ✅ 查询未读消息
- ✅ 统计今日消息数
- ✅ 统计总消息数

**缺失功能**:
- ❌ **会议室消息持久化**（当前会议室消息仅存内存）
- ❌ 消息统计分析（活跃用户、消息趋势）
- ❌ 消息搜索功能

---

## 完善方案

### 🎯 方案1: 会议室通话/消息记录（核心需求）

#### 1.1 新建会议室记录表
```sql
CREATE TABLE conference_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    room_id VARCHAR(50) NOT NULL COMMENT '会议室ID',
    creator VARCHAR(50) NOT NULL COMMENT '创建者',
    room_name VARCHAR(100) COMMENT '会议室名称',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    ended_at TIMESTAMP NULL COMMENT '结束时间',
    duration INT COMMENT '会议时长（秒）',
    max_participants INT DEFAULT 0 COMMENT '最大参与人数',
    total_messages INT DEFAULT 0 COMMENT '总消息数',
    status VARCHAR(20) DEFAULT 'ACTIVE' COMMENT '状态: ACTIVE, ENDED, EXPIRED',
    INDEX idx_room_id (room_id),
    INDEX idx_creator (creator),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='会议室记录表';
```

#### 1.2 会议室参与者记录表
```sql
CREATE TABLE conference_participants (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    room_id VARCHAR(50) NOT NULL COMMENT '会议室ID',
    username VARCHAR(50) NOT NULL COMMENT '参与者用户名',
    joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '加入时间',
    left_at TIMESTAMP NULL COMMENT '离开时间',
    duration INT COMMENT '参与时长（秒）',
    is_video_enabled BOOLEAN DEFAULT TRUE COMMENT '是否开启视频',
    is_audio_enabled BOOLEAN DEFAULT TRUE COMMENT '是否开启音频',
    messages_sent INT DEFAULT 0 COMMENT '发送消息数',
    INDEX idx_room_id (room_id),
    INDEX idx_username (username),
    INDEX idx_joined_at (joined_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='会议室参与者记录表';
```

#### 1.3 会议室消息持久化表
```sql
CREATE TABLE conference_messages (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    room_id VARCHAR(50) NOT NULL COMMENT '会议室ID',
    from_user VARCHAR(50) NOT NULL COMMENT '发送者',
    content TEXT NOT NULL COMMENT '消息内容',
    message_type VARCHAR(20) DEFAULT 'text' COMMENT '消息类型',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '发送时间',
    INDEX idx_room_id (room_id),
    INDEX idx_from_user (from_user),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='会议室消息表';
```

---

### 🎯 方案2: 增强统计功能

#### 2.1 新增统计表（可选，用于性能优化）
```sql
CREATE TABLE daily_statistics (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    stat_date DATE NOT NULL UNIQUE COMMENT '统计日期',
    total_users INT DEFAULT 0 COMMENT '总用户数',
    active_users INT DEFAULT 0 COMMENT '活跃用户数',
    total_calls INT DEFAULT 0 COMMENT '通话次数',
    total_call_duration INT DEFAULT 0 COMMENT '通话时长（秒）',
    total_messages INT DEFAULT 0 COMMENT '消息数',
    total_conferences INT DEFAULT 0 COMMENT '会议室数',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_stat_date (stat_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='每日统计表';
```

---

### 🎯 方案3: 用户行为日志（可选）

```sql
CREATE TABLE user_activity_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL COMMENT '用户名',
    activity_type VARCHAR(50) NOT NULL COMMENT '活动类型',
    description TEXT COMMENT '活动描述',
    ip_address VARCHAR(50) COMMENT 'IP地址',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '时间',
    INDEX idx_username (username),
    INDEX idx_activity_type (activity_type),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户活动日志表';
```

---

## 实现计划

### 第一阶段：会议室记录核心功能（推荐优先实现）

#### 后端实现
1. **创建实体类**
   - `ConferenceLog.java` - 会议室记录
   - `ConferenceParticipant.java` - 参与者记录
   - `ConferenceMessage.java` - 会议室消息（持久化版本）

2. **创建Mapper**
   - `ConferenceLogMapper.java`
   - `ConferenceParticipantMapper.java`
   - `ConferenceMessageMapper.java`

3. **扩展ConferenceService**
   - 添加会议室生命周期记录
   - 添加参与者加入/离开记录
   - 添加消息持久化（可选：同时保存到内存和数据库）

4. **新增API接口**
   - `GET /api/conference/logs` - 获取会议室记录列表
   - `GET /api/conference/logs/{roomId}` - 获取单个会议室详情
   - `GET /api/conference/logs/{roomId}/participants` - 获取参与者记录
   - `GET /api/conference/logs/{roomId}/messages` - 获取消息记录（持久化）
   - `GET /api/conference/statistics` - 会议室统计

5. **修改现有功能**
   - 在创建会议室时自动创建记录
   - 在参与者加入/离开时记录
   - 在会议结束时更新记录（计算时长、统计数据）
   - 消息发送时同时保存到数据库

### 第二阶段：统计和分析功能

1. **扩展AdminController**
   - 添加会议室统计接口
   - 添加时间范围统计（日/周/月）
   - 添加TOP统计（最活跃用户、最热门会议室等）

2. **定时任务**
   - 每日统计汇总任务
   - 过期数据清理任务

### 第三阶段：用户行为日志（可选）

1. 使用AOP记录关键操作
2. 实现日志查询和分析接口

---

## 关键设计决策

### 1. **会议室消息存储策略**
**选项A：仅内存存储**（当前方案）
- ✅ 优点：性能好，实时性强
- ❌ 缺点：服务器重启消息丢失，无法追溯历史

**选项B：内存+数据库双写**（推荐）
- ✅ 优点：兼顾性能和持久化
- ✅ 适合：会议室消息需要保留记录
- 实现：异步写入数据库，不影响实时性

**选项C：仅数据库存储**
- ✅ 优点：数据完整性好
- ❌ 缺点：性能较差，需要频繁查询

**推荐方案**：选项B - 内存+数据库双写
- 实时消息从内存读取（当前逻辑不变）
- 消息发送时异步写入数据库
- 会议结束后可查询历史记录

### 2. **记录触发时机**
- **会议室创建**：立即创建 `conference_logs` 记录
- **参与者加入**：创建 `conference_participants` 记录
- **参与者离开**：更新 `conference_participants` 的 `left_at` 和 `duration`
- **消息发送**：异步写入 `conference_messages`
- **会议结束**：更新 `conference_logs` 的 `ended_at`、`duration`、统计字段

### 3. **性能优化**
- 使用异步写入避免阻塞
- 批量插入消息记录
- 定期归档历史数据
- 添加索引优化查询

---

## 实现优先级

### 🔴 高优先级（必须实现）
1. **会议室记录表** - 记录会议室基本信息
2. **参与者记录表** - 记录参与者行为
3. **会议室生命周期管理** - 创建、结束时记录
4. **基础查询API** - 查询会议室历史记录

### 🟡 中优先级（建议实现）
5. **消息持久化** - 会议室消息保存到数据库
6. **统计分析功能** - 提供统计数据
7. **管理后台增强** - 添加会议室管理功能

### 🟢 低优先级（可选）
8. **用户行为日志** - 详细的操作日志
9. **数据归档** - 自动归档历史数据
10. **高级分析** - 数据可视化、报表

---

## 数据库迁移脚本

创建新表的SQL脚本（按优先级）：

**第一步：核心表**
```sql
-- 会议室记录表
CREATE TABLE conference_logs (...);

-- 参与者记录表
CREATE TABLE conference_participants (...);
```

**第二步：消息持久化**
```sql
-- 会议室消息表
CREATE TABLE conference_messages (...);
```

**第三步：统计表（可选）**
```sql
-- 每日统计表
CREATE TABLE daily_statistics (...);
```

---

## 对现有功能的影响

### ✅ 不影响现有功能
- 现有通话记录、消息记录功能保持不变
- 会议室实时功能（轮询、消息推送）保持不变
- 前端UI不需要修改（记录功能是后台功能）

### 🔧 需要修改的地方
- `ConferenceService.java` - 添加记录逻辑
- `ConferenceController.java` - 添加查询API
- `AdminController.java` - 添加统计接口

### 📊 性能影响
- 数据库写入增加（可通过异步优化）
- 查询历史记录时需要数据库访问
- 整体影响较小（异步写入不影响实时性）

---

## 总结

本方案旨在完善会议室功能的后台记录，主要包括：

1. **会议室记录** - 记录每个会议室的创建、结束、时长等信息
2. **参与者记录** - 记录每个参与者的加入、离开、时长等信息
3. **消息持久化** - 将会议室消息保存到数据库
4. **统计分析** - 提供各种统计数据

**推荐实现步骤**：
1. 先实现会议室和参与者记录（核心功能）
2. 再实现消息持久化（可选但推荐）
3. 最后实现统计分析功能（锦上添花）

这样可以循序渐进，确保每一步都稳定可用。
