# 代码修改与重新部署流程

## 🔄 核心原则

**修改代码后 → 重新打包 → 重新部署**

不要从 GitHub 重新下载覆盖！那样会丢失你的修改。

---

## 📝 三种修改场景

### 场景1：修改客户端代码（sip-client）

**影响范围**：只影响客户端程序

**修改示例**：
- UI 界面调整（MainController.java, AdminController.java）
- 媒体处理逻辑（MediaManager.java）
- SIP 通话逻辑（SipManager.java）
- 客户端配置（ClientConfig.java）

**重新部署步骤**：

```bash
# 步骤1：运行自动打包脚本
build-client-for-remote.bat

# 步骤2：将生成的 client-deploy 文件夹复制到客户端电脑（覆盖旧的）

# 步骤3：在客户端电脑上重新运行
start.bat
```

**注意**：
- ✅ 服务器端不需要重启
- ✅ 只需要更新客户端程序
- ⚠️ 所有客户端电脑都需要更新

---

### 场景2：修改服务器端代码（sip-server）

**影响范围**：只影响服务器

**修改示例**：
- API 接口（AuthController.java, UserController.java 等）
- 业务逻辑（UserService.java 等）
- 数据库操作（Mapper 文件）
- 服务器配置（application.yml）

**重新部署步骤**：

```bash
# 步骤1：重新编译打包
mvn clean package -DskipTests

# 步骤2：停止服务器
Ctrl+C 停止正在运行的 start-server.bat

# 步骤3：重新启动服务器
start-server.bat
```

**注意**：
- ✅ 客户端不需要更新
- ✅ 客户端会自动连接到新的服务器
- ⚠️ 服务器重启时，客户端会暂时断开连接

---

### 场景3：修改公共模块（sip-common）

**影响范围**：同时影响服务器和客户端

**修改示例**：
- 实体类（User.java, Message.java 等）
- DTO 类（ApiResponse.java, MessageDTO.java 等）
- 常量定义（UserStatus.java, MessageType.java 等）

**重新部署步骤**：

```bash
# 步骤1：重新编译整个项目
mvn clean package -DskipTests

# 步骤2：重启服务器
# 停止 start-server.bat (Ctrl+C)
start-server.bat

# 步骤3：重新打包客户端
build-client-for-remote.bat

# 步骤4：将 client-deploy 复制到所有客户端电脑

# 步骤5：所有客户端重新运行
start.bat
```

**注意**：
- ⚠️ 必须同时更新服务器和所有客户端
- ⚠️ 版本不一致可能导致通信错误

---

## 🚀 快速参考表

| 修改了什么 | 需要重新打包 | 需要重启服务器 | 需要更新客户端 |
|-----------|------------|--------------|--------------|
| **客户端代码** | ✅ | ❌ | ✅ |
| **服务器代码** | ✅ | ✅ | ❌ |
| **公共模块** | ✅ | ✅ | ✅ |
| **只改配置** | ✅ | ✅ (服务器配置) | ✅ (客户端配置) |

---

## 💻 常用命令速查

### 完整重新编译（所有模块）
```bash
mvn clean package -DskipTests
```

### 只编译客户端
```bash
cd sip-client
mvn clean package -DskipTests
cd ..
```

### 只编译服务器
```bash
cd sip-server
mvn clean package -DskipTests
cd ..
```

### 打包客户端部署包（自动修改配置）
```bash
build-client-for-remote.bat
```

### 启动服务器
```bash
start-server.bat
```

### 启动客户端（本地测试）
```bash
start-client.bat
```

---

## 🔍 开发调试流程

### 典型的开发循环

```
1. 修改代码
   ↓
2. 编译测试
   mvn clean package -DskipTests
   ↓
3. 本地运行测试
   - 启动服务器：start-server.bat
   - 启动客户端：start-client.bat
   ↓
4. 发现问题 → 回到步骤1
   没问题 → 继续步骤5
   ↓
5. 打包部署
   build-client-for-remote.bat
   ↓
6. 部署到客户端电脑
```

---

## 📦 文件生成位置

### 编译后的文件

```
项目结构：
sipEx/
├── sip-common/target/
│   └── sip-common-1.0.0.jar          # 公共模块
│
├── sip-server/target/
│   └── sip-server-1.0.0.jar          # 服务器可执行文件
│
├── sip-client/target/
│   └── sip-client-1.0.0.jar          # 客户端可执行文件
│
└── client-deploy/                     # 客户端部署包（运行脚本生成）
    ├── sip-client-1.0.0.jar
    └── start.bat
```

---

## ⚠️ 注意事项

### 1. 不要从 GitHub 重新下载覆盖

**错误做法**：
```bash
# ❌ 不要这样做！
git clone https://github.com/ChlorineHi/sipCom.git
# 这会丢失你的本地修改！
```

**正确做法**：
```bash
# ✅ 直接在本地修改和编译
# 修改代码...
mvn clean package -DskipTests
```

### 2. 配置文件需要注意

**ClientConfig.java**：
- 开发时保持 `SERVER_HOST = "localhost"`
- 使用 `build-client-for-remote.bat` 会自动改为服务器 IP
- 脚本执行后会自动恢复为 localhost

**application.yml**：
- 数据库连接信息
- 端口配置
- 根据实际环境修改

### 3. 版本控制建议

**提交代码到 Git 之前**：
```bash
# 1. 确保代码能正常编译
mvn clean package -DskipTests

# 2. 测试功能正常

# 3. 提交到 Git
git add .
git commit -m "描述你的修改"
git push
```

### 4. 多客户端更新

如果有多台客户端电脑：
- 需要将新的 `client-deploy` 文件夹复制到**每一台**客户端电脑
- 建议统一版本，避免不兼容

---

## 🐛 常见问题

### Q1: 修改代码后编译报错怎么办？

**A**: 查看错误信息，修复代码问题
```bash
# 查看详细错误
mvn clean package
```

### Q2: 重新打包后客户端还是旧版本？

**A**: 可能原因：
1. 没有覆盖旧的 jar 文件
2. 客户端没有重启
3. 打包后的文件没有正确复制

**解决**：
```bash
# 确保使用新打包的文件
# 删除客户端电脑上的旧文件，重新复制
```

### Q3: 服务器更新后客户端连不上？

**A**: 检查：
1. 服务器是否成功重启
2. 端口是否被占用
3. 如果修改了公共模块，客户端也需要更新

### Q4: 如何确认使用的是新版本？

**A**: 在代码中添加版本日志：
```java
// 在客户端启动时打印
System.out.println("客户端版本: 2024-10-22 v1.1");

// 在服务器启动时打印
System.out.println("服务器版本: 2024-10-22 v1.1");
```

---

## 📋 快速检查清单

### 修改客户端代码后：
- [ ] 运行 `build-client-for-remote.bat`
- [ ] 检查 `client-deploy` 文件夹是否生成
- [ ] 复制到客户端电脑
- [ ] 客户端重新运行 `start.bat`
- [ ] 测试新功能

### 修改服务器代码后：
- [ ] 运行 `mvn clean package -DskipTests`
- [ ] 停止旧的服务器进程
- [ ] 运行 `start-server.bat`
- [ ] 检查服务器是否正常启动
- [ ] 客户端测试连接

### 修改公共模块后：
- [ ] 运行 `mvn clean package -DskipTests`
- [ ] 重启服务器
- [ ] 运行 `build-client-for-remote.bat`
- [ ] 更新所有客户端
- [ ] 测试服务器和客户端功能

---

## 🎯 最佳实践

1. **小步迭代**：每次只修改一小部分功能，及时测试
2. **本地测试**：先在本地测试，确认没问题再部署到客户端
3. **版本记录**：重要修改记录版本号和修改内容
4. **备份重要文件**：修改前备份关键文件
5. **Git 提交**：功能稳定后及时提交到 Git

---

## 📚 相关文档

- `快速部署步骤.md` - 初次部署流程
- `客户端电脑配置清单.md` - 客户端配置要求
- `问题排查与解决方案.md` - 问题排查指南
- `启动指南.md` - 系统启动说明

