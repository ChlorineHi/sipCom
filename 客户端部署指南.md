# 客户端部署指南

## 架构说明

### 服务器端（当前电脑 - 10.129.161.35）
- **Kamailio SIP 服务器**: 端口 5060
- **Spring Boot 后端**: 端口 8080
- **MySQL 数据库**: 端口 3306

### 客户端（其他电脑）
- 连接到服务器进行认证和消息传递
- 通过 Kamailio 进行 SIP 注册和通话

## 客户端部署步骤

### 方法一：直接使用配置好的客户端（推荐）

#### 1. 在服务器电脑上准备客户端包

```bash
# 1. 进入 sip-client 目录
cd sip-client

# 2. 打包客户端（跳过测试）
mvn clean package -DskipTests

# 3. 将 target 目录下的 jar 包复制到 U 盘或通过网络传输
# 文件位置：sip-client/target/sip-client-1.0.0.jar
```

#### 2. 在客户端电脑上运行

将 `sip-client-1.0.0.jar` 复制到客户端电脑，然后运行：

```bash
java -jar sip-client-1.0.0.jar
```

**注意**: 当前配置已经指向服务器 IP（10.129.161.35），可以直接使用！

---

### 方法二：在客户端电脑上编译（需要修改配置）

如果需要从源码编译，需要先修改配置：

#### 1. 复制项目到客户端电脑

复制以下文件/文件夹到客户端电脑：
```
sipEx/
├── sip-client/        # 客户端模块
├── sip-common/        # 公共模块（客户端依赖）
├── pom.xml           # 父 POM
└── .gitignore
```

#### 2. 修改客户端配置

打开 `sip-client/src/main/java/com/sipex/client/config/ClientConfig.java`

修改以下配置：

```java
// 修改前（本地测试）
public static final String SERVER_HOST = "localhost";

// 修改后（连接远程服务器）
public static final String SERVER_HOST = "10.129.161.35";
```

**注意**: `KAMAILIO_HOST` 已经是 `10.129.161.35`，不需要修改！

#### 3. 打包并运行

```bash
# 进入项目根目录
cd sipEx

# 打包项目
mvn clean package -DskipTests

# 运行客户端
cd sip-client
java -jar target/sip-client-1.0.0.jar
```

---

## 配置文件说明

### ClientConfig.java 重要配置项

| 配置项 | 默认值 | 说明 | 是否需要修改 |
|--------|--------|------|--------------|
| `SERVER_HOST` | localhost | Spring Boot 服务器地址 | ✅ **需要改为服务器 IP** |
| `SERVER_PORT` | 8080 | Spring Boot 服务端口 | ❌ 不需要 |
| `KAMAILIO_HOST` | 10.129.161.35 | Kamailio SIP 服务器地址 | ❌ 已配置好 |
| `KAMAILIO_PORT` | 5060 | SIP 服务端口 | ❌ 不需要 |
| `LOCAL_SIP_PORT` | 5070 | 客户端 SIP 监听端口 | ❌ 不需要（自动） |

### 网络要求

确保客户端电脑能够访问服务器的以下端口：

- **8080** - HTTP/WebSocket（用户认证、消息、文件传输）
- **5060** - SIP 信令（通话建立、SIP 注册）
- **10000-20000** - RTP 媒体流（音视频传输）

### 防火墙配置

在服务器电脑上，需要开放以下端口：

```bash
# Windows 防火墙规则
# 方法1：通过控制面板 → Windows Defender 防火墙 → 高级设置 → 入站规则

# 方法2：使用 PowerShell 命令（需要管理员权限）
New-NetFirewallRule -DisplayName "SIP Server HTTP" -Direction Inbound -LocalPort 8080 -Protocol TCP -Action Allow
New-NetFirewallRule -DisplayName "SIP Server SIP" -Direction Inbound -LocalPort 5060 -Protocol UDP -Action Allow
New-NetFirewallRule -DisplayName "SIP Server RTP" -Direction Inbound -LocalPort 10000-20000 -Protocol UDP -Action Allow
```

---

## 测试连接

### 1. 测试 HTTP 连接

在客户端电脑上，打开浏览器访问：
```
http://10.129.161.35:8080/api/auth/test
```

如果能看到响应，说明 HTTP 连接正常。

### 2. 测试 SIP 连接

运行客户端程序后：
1. 使用测试账号登录（alice/123456 或 bob/123456）
2. 查看控制台是否显示 "SIP注册成功"
3. 尝试发送消息或拨打电话

### 常见问题排查

**问题1：无法连接到服务器**
- 检查服务器 IP 是否正确
- 检查防火墙是否开放端口
- 使用 `ping 10.129.161.35` 测试网络连通性

**问题2：SIP 注册失败**
- 检查 Kamailio 服务是否运行
- 检查端口 5060 是否开放
- 查看客户端控制台的详细错误信息

**问题3：可以登录但无法通话**
- 检查 RTP 端口范围（10000-20000）是否开放
- 确认两个客户端都在线
- 检查双方网络是否能互相访问

---

## 快速启动脚本

### 服务器端启动脚本（已有）

使用项目根目录的 `start-server.bat`

### 客户端启动脚本

创建 `start-client-remote.bat`（用于连接远程服务器）：

```batch
@echo off
echo ========================================
echo    SipEx 客户端启动（远程模式）
echo    服务器地址: 10.129.161.35
echo ========================================
echo.

cd sip-client
java -jar target/sip-client-1.0.0.jar

pause
```

---

## 多客户端测试

### 推荐测试场景

1. **同一台电脑多客户端**
   - 运行多个客户端实例
   - 使用不同账号登录（alice, bob）
   - 测试点对点通话和消息

2. **两台电脑**
   - 服务器电脑：运行 1 个客户端
   - 另一台电脑：运行 1 个客户端
   - 测试跨网络通话

3. **三台及以上**
   - 测试群组消息
   - 测试多方会议（如果实现）

---

## 注意事项

1. ⚠️ **确保两台电脑在同一局域网内**（或网络可达）
2. ⚠️ **服务器电脑需要保持运行**（Kamailio + Spring Boot）
3. ⚠️ **每个客户端需要使用不同的账号登录**
4. ⚠️ **注意端口冲突**（同一台电脑运行多个客户端时）
5. ⚠️ **数据库只在服务器端运行**（客户端不需要数据库）

---

## 目录结构（客户端部署）

**最小部署包（只需要 jar 文件）**：
```
客户端电脑/
└── sip-client-1.0.0.jar
```

**完整源码部署包**：
```
客户端电脑/
├── sip-client/
├── sip-common/
├── pom.xml
└── .gitignore
```

---

## 联系与支持

如有问题，请查看：
- `问题排查与解决方案.md`
- `启动指南.md`
- `Linphone测试指南.md`

