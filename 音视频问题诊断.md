# 音视频传输问题诊断

## 🔴 当前问题

1. **没有音频流** - 日志中没有 "✅ 真实RTP音频流已启动!" 
2. **没有接收到远程视频** - 呼叫显示 "408 Request Timeout"
3. **对方无法接听** - 一直显示 "呼叫中... 状态码: 100"

---

## 📋 检查清单

### 1️⃣ 检查音频硬件
```bash
# 运行音频诊断工具
cd E:\sipEx\sip-client
java -cp target/sip-client-1.0.0.jar com.sipex.client.util.AudioFormatDiagnostics
```

**预期输出：**
- ✅ 列出系统中的麦克风
- ✅ 支持的音频格式列表

---

### 2️⃣ 检查网络连接

**检查是否能连接到 SIP 服务器（Kamailio）：**
```bash
# 测试 SIP 服务器连接
ping 10.129.174.156

# 测试 SIP 端口（5060）
telnet 10.129.174.156 5060
```

**检查 RTP 端口是否开放：**
```bash
# Windows 防火墙规则检查
Get-NetFirewallRule -DisplayName *RTP* -ErrorAction SilentlyContinue

# 查看正在使用的端口
netstat -ano | findstr LISTENING
```

---

### 3️⃣ 检查 Bob 是否在线

日志中看到：
```
向 bob 发起群聊呼叫
呼叫中... 状态码: 100
呼叫失败: 408 Request Timeout
```

**问题分析：**
- ❌ 状态码 100 = 尝试中（没有问题）
- ❌ 408 Request Timeout = **对方没有接听或不在线**

**解决方法：**
1. 确保 bob 的客户端已启动
2. 确保 bob 已登录
3. 检查 bob 的防火墙设置

---

### 4️⃣ 检查媒体流启动日志

**关键日志检查：**
```
✅ 应该看到：
  - 启动音频流...
  - 远程音频地址: xxx:xxx
  - ✅ 真实RTP音频流已启动!
  - RTP音频发送器已启动: xxx:xxx
  
❌ 如果看到：
  - ❌ 音频发送器启动失败
  - ⚠️  音频接收器启动失败
```

---

### 5️⃣ 检查群聊模式 vs 双人模式

**群聊模式使用：**
- `ConferenceMediaManager` + `AudioMixer` + `RtpAudioForwarder`
- **需要多参与者音频混音**

**双人模式使用：**
- `MediaManager` + `RtpAudioSender` + `RtpAudioReceiver`
- **直接点对点传输**

---

## 🔧 故障排查步骤

### Step 1: 运行音频诊断
```bash
java -cp sip-client/target/sip-client-1.0.0.jar com.sipex.client.util.AudioFormatDiagnostics
```

### Step 2: 检查网络
```bash
# 检查到服务器的连接
ping 10.129.174.156

# 检查 SIP 端口
netstat -ano | findstr :5060
```

### Step 3: 查看详细日志
从客户端启动时保存完整的控制台输出

### Step 4: 检查防火墙
```bash
# 添加 RTP 端口范围到防火墙白名单
# RTP 通常使用: 10000-20000
```

---

## ⚠️ 常见原因

| 症状 | 原因 | 解决方案 |
|------|------|--------|
| 408 Request Timeout | 对方客户端未运行或离线 | 启动对方客户端，检查登录状态 |
| 没有音频流日志 | 音频硬件不支持或初始化失败 | 运行 AudioFormatDiagnostics |
| 没有远程视频 | 对方未成功接听 | 检查对方是否接听，检查网络 |
| 防火墙阻止 | Windows 防火墙或路由器 | 添加应用到白名单 |
| 端口冲突 | RTP 端口已被占用 | 查看 netstat，重启应用 |

---

## 📝 必要信息

请收集以下信息进行诊断：

1. **系统信息**
   - Windows 版本
   - Java 版本：`java -version`

2. **音频诊断结果**
   - `AudioFormatDiagnostics` 的完整输出

3. **完整日志**
   - 客户端启动的完整日志（包括错误信息）

4. **网络检查**
   - Ping 服务器的结果
   - `netstat -ano` 输出

---

## 🆘 如果问题仍未解决

请提供：
1. 完整的启动日志（从启动到呼叫失败）
2. `AudioFormatDiagnostics` 的输出
3. 网络配置信息（IP、防火墙等）

