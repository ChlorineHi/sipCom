# SipEx 网络架构说明

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                    服务器电脑 (10.129.161.35)                    │
│                                                                   │
│  ┌─────────────────┐  ┌──────────────────┐  ┌────────────────┐ │
│  │   Kamailio      │  │  Spring Boot     │  │     MySQL      │ │
│  │  SIP Server     │  │   后端服务        │  │    数据库      │ │
│  │   Port: 5060    │  │   Port: 8080     │  │  Port: 3306    │ │
│  └─────────────────┘  └──────────────────┘  └────────────────┘ │
│          │                      │                     │          │
│          │                      │                     │          │
└──────────┼──────────────────────┼─────────────────────┼──────────┘
           │                      │                     │
           │                      │                     │ (内部访问)
           │                      │                     
    (SIP信令)               (HTTP/WebSocket)                
           │                      │                     
  ─────────┴──────────────────────┴─────────────────────────────
                           局域网
  ─────────┬──────────────────────┬─────────────────────────────
           │                      │                     
           │                      │                     
┌──────────┴──────────┐  ┌────────┴────────────┐
│   客户端电脑 A       │  │   客户端电脑 B       │
│                     │  │                     │
│  ┌───────────────┐  │  │  ┌───────────────┐  │
│  │  SipEx Client │  │  │  │  SipEx Client │  │
│  │  (alice)      │  │  │  │  (bob)        │  │
│  │               │  │  │  │               │  │
│  │  Port: 5070   │  │  │  │  Port: 5070   │  │
│  │  RTP: 10000+  │  │  │  │  RTP: 10000+  │  │
│  └───────────────┘  │  │  └───────────────┘  │
└─────────────────────┘  └─────────────────────┘
```

## 通信流程

### 1. 用户登录流程
```
客户端                    Spring Boot                 MySQL
  │                           │                        │
  ├──[1] POST /api/auth/login─→                       │
  │   (username: alice)       │                        │
  │                           ├──[2] 查询用户────────→│
  │                           ←──[3] 返回用户信息─────┤
  │                           │                        │
  │   [4] JWT Token ←─────────┤                        │
  │   (保存到本地)            │                        │
```

### 2. SIP 注册流程
```
客户端                    Kamailio                  Spring Boot
  │                           │                          │
  ├──[1] SIP REGISTER────────→│                          │
  │   (用户: alice)           │                          │
  │                           ├──[2] 验证用户──────────→│
  │                           ←──[3] 验证成功───────────┤
  │                           │                          │
  │   [4] 200 OK ←────────────┤                          │
  │   (注册成功)              │                          │
```

### 3. 点对点通话流程
```
Alice客户端            Kamailio            Bob客户端
    │                     │                    │
    ├──[1] INVITE────────→│                    │
    │   (呼叫 bob)        ├──[2] INVITE───────→│
    │                     │                    │
    │                     ←──[3] 180 Ringing──┤
    │   [4] 180 Ringing←──┤                    │
    │                     │                    │
    │                     ←──[5] 200 OK────────┤
    │   [6] 200 OK ←──────┤                    │
    │                     │                    │
    ├──[7] ACK───────────→│                    │
    │                     ├──[8] ACK──────────→│
    │                     │                    │
    ├═══[9] RTP 音视频流═══════════════════════→│
    ←═══[10] RTP 音视频流══════════════════════┤
    │        (P2P 直连)                        │
```

### 4. 消息传递流程
```
Alice客户端         WebSocket服务器         Bob客户端
    │                     │                    │
    ├──[1] 发送消息──────→│                    │
    │   (给 bob)          │                    │
    │                     ├──[2] 推送消息─────→│
    │                     │                    │
    │   [3] 消息已送达←───┤                    │
    │                     ←──[4] 消息已读─────┤
```

## 端口使用说明

### 服务器端口

| 端口 | 协议 | 用途 | 是否需要外部访问 |
|------|------|------|-----------------|
| 3306 | TCP | MySQL 数据库 | ❌ 仅本地 |
| 8080 | TCP | HTTP/WebSocket | ✅ 客户端需要访问 |
| 5060 | UDP | SIP 信令 | ✅ 客户端需要访问 |
| 10000-20000 | UDP | RTP 媒体流 | ✅ P2P 通话需要 |

### 客户端端口

| 端口 | 协议 | 用途 | 说明 |
|------|------|------|------|
| 5070 | UDP | SIP 客户端监听 | 每个客户端固定 |
| 10000-20000 | UDP | RTP 媒体流 | 动态分配 |

## 网络要求

### 最小网络配置

1. **服务器和客户端在同一局域网**
   - 可以直接使用内网 IP（10.129.161.35）
   - 无需配置 NAT 穿透

2. **防火墙规则**（服务器端）
   ```
   允许入站: TCP 8080
   允许入站: UDP 5060
   允许入站: UDP 10000-20000
   ```

3. **客户端网络**
   - 需要能访问服务器的 8080 和 5060 端口
   - RTP 端口需要双向通信

### 扩展网络配置（外网访问）

如果需要从外网访问，需要配置：

1. **路由器端口转发**
   ```
   外网端口 → 内网地址:端口
   8080    → 10.129.161.35:8080
   5060    → 10.129.161.35:5060
   10000-20000 → 10.129.161.35:10000-20000
   ```

2. **动态域名（可选）**
   - 使用 DDNS 服务（如花生壳、阿里云 DDNS）
   - 将域名指向你的公网 IP

## 配置检查清单

### ✅ 服务器端检查

- [ ] Kamailio 服务已启动（端口 5060）
- [ ] Spring Boot 服务已启动（端口 8080）
- [ ] MySQL 数据库已启动（端口 3306）
- [ ] 防火墙已开放必要端口
- [ ] 服务器 IP 地址已确认（10.129.161.35）

### ✅ 客户端端检查

- [ ] 能 ping 通服务器 IP
- [ ] 能访问 http://10.129.161.35:8080
- [ ] ClientConfig.java 中 SERVER_HOST 已修改
- [ ] 已使用正确的 jar 文件
- [ ] 网络允许 UDP 通信（防火墙/杀毒软件）

## 故障排查

### 问题：无法连接到服务器

**可能原因**：
1. 服务器未启动
2. 防火墙阻止
3. IP 地址配置错误
4. 网络不通

**排查步骤**：
```bash
# 1. 测试网络连通性
ping 10.129.161.35

# 2. 测试 HTTP 端口
curl http://10.129.161.35:8080

# 3. 查看服务器日志
# 服务器端查看 Spring Boot 日志

# 4. 查看客户端日志
# 客户端控制台输出
```

### 问题：SIP 注册失败

**可能原因**：
1. Kamailio 未启动
2. 端口 5060 被阻止
3. 用户名密码错误

**排查步骤**：
```bash
# 1. 服务器端检查 Kamailio
# 查看 Kamailio 进程是否运行

# 2. 测试 SIP 端口
# PowerShell
Test-NetConnection -ComputerName 10.129.161.35 -Port 5060

# 3. 查看 Kamailio 日志
```

### 问题：可以登录但无法通话

**可能原因**：
1. RTP 端口被阻止
2. 对方不在线
3. NAT 穿透问题

**排查步骤**：
1. 确认双方都已注册
2. 检查 RTP 端口是否开放
3. 查看客户端控制台的 SDP 信息

## IP 地址配置总结

### 当前配置

| 组件 | IP地址 | 说明 |
|------|--------|------|
| 服务器实际IP | 10.129.161.35 | 你的服务器电脑 |
| Kamailio配置 | 10.129.161.35 | ✅ 已正确配置 |
| Spring Boot | localhost → 需改为 10.129.161.35 | ⚠️ 需要修改 |

### 需要修改的位置

**ClientConfig.java**：
```java
// 第 5 行 - 需要修改
public static final String SERVER_HOST = "10.129.161.35";  // 改这里！

// 第 11 行 - 已正确
public static final String KAMAILIO_HOST = "10.129.161.35";  // 不需要改
```

## 快速开始命令

### 服务器端
```bash
# 1. 启动 MySQL（如果未自动启动）
# 2. 启动 Kamailio
# 3. 启动 Spring Boot
start-server.bat
```

### 客户端端（本机测试）
```bash
start-client.bat
```

### 客户端端（远程连接）
```bash
# 方法1: 使用自动构建脚本
build-client-for-remote.bat

# 方法2: 手动修改并打包
# 1. 修改 ClientConfig.java
# 2. mvn clean package -DskipTests
# 3. java -jar sip-client\target\sip-client-1.0.0.jar
```

## 测试账号

| 用户名 | 密码 | 说明 |
|--------|------|------|
| alice | 123456 | 测试用户 1 |
| bob | 123456 | 测试用户 2 |
| charlie | 123456 | 测试用户 3 |

## 更多信息

详细配置和部署说明，请参考：
- `配置修改说明.md` - 配置文件修改详解
- `客户端部署指南.md` - 客户端部署步骤
- `启动指南.md` - 系统启动流程
- `问题排查与解决方案.md` - 常见问题解决

